# {{ ansible_managed }}

{% block server_before %}{% endblock %}

server {
  {% block server_id -%}
  listen 80;
  server_name {{ server_url }};
  {% endblock %}

  {% block logs -%}
  access_log   {{ www_root }}/logs/access.log main;
  error_log    {{ www_root }}/logs/error.log;
  {% endblock %}

  {% block server_basic -%}
  root  {{ www_root }}/current/public;
  index index.php index.htm index.html;
  add_header Fastcgi-Cache $upstream_cache_status;
  charset utf-8;

  # Set the max body size equal to PHP's max POST size.
  client_max_body_size {{ php_post_max_size | default('25m') | lower }};

  {% if env == 'development' -%}
  # https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#virtualbox
  sendfile off;

  {% endif -%}
  {% endblock -%}

  {% block includes_d -%}
  include includes.d/*.conf;

  {% endblock -%}

  {% block location_primary -%}
  location / {
    try_files $uri $uri/ /index.php;
  }
  {% endblock %}

  {% block h5bp -%}
  include h5bp/directive-only/x-ua-compatible.conf;
  include h5bp/directive-only/extra-security.conf;
  include h5bp/location/cross-domain-fonts.conf;
  include h5bp/location/protect-system-files.conf;
  {% endblock %}

  {% block location_php -%}
  location ~ \.php$ {
    {% block location_php_basic -%}
    try_files $uri /index.php;

    {% endblock -%}

    {% block fastcgi_basic -%}
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT $realpath_root;
    fastcgi_pass unix:/var/run/php-fpm-wordpress.sock;
    {%- endblock %}

  }
  {%- endblock %}

}
